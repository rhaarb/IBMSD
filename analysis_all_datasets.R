# Richard Haarburger, Peter Kramlinger 2022-2023, with some
# adaptation for LASI by Erik Meijer.
# This version: 2023-02-15

# load packages
library(ggplot2)
library(dplyr)
library(ggpubr)
library(lme4)
library(parallel)
library(pbmcapply)
library(moments)
library(haven)

## Choose data set
dataset.name <- "iflsmerg_" # will load "iflsmerged.Rdata", which is the output generated by "merge_ifls.R"
# dataset.name <- "nids_" # will load "nids_cleaned.rds", which is the output generated by "nids_cleaning_all_waves.R"
# dataset.name <- "lasiw1_" # will load "lasi03.dta", which is the output generated by "make_lasi_data.to"

### Data preparation
## load data
if (dataset.name=="iflsmerg_"){
  load(file="~/iflsmerged.Rdata")
}
if (dataset.name=="nids_"){
  comb_2 <- readRDS(file="~/nids_cleaned.rds")
}
if (dataset.name=="lasiw1_"){
  comb_2 <- read_dta("~/lasi03.dta")
}

# define paths to load source codes from and to where to save plots to
path.codes <- "~"
path.plots <- "~/plots/"

# select variables of interest, comb_2 is the dataframe loaded above
if (dataset.name=="iflsmerg_"){
  data <- dplyr::select(comb_2,
                        # province,
                        province,
                        # rural vs. urban control, 1=urban, 2=rural
                        ruralurban,
                        # interviewer ID
                        int.id,
                        # household ID,
                        hh.id,
                        # main measurement of sbp (average of second and 3rd measurement)
                        sbp=sbp.main,
                        # sex as 0=male, female=1
                        sex,
                        # age in years
                        age,
                        # age in years squared
                        age.sq,
                        # highest level of education achieved: primary/secondary, tertiary
                        edu,
                        # body-mass-index (standard formula: (body weight in kg / (height in m)^2)
                        bmi,
                        # bmi squared
                        bmi.sq,
                        # log of income variable
                        income.scaled=income.log,
                        # active smoking status: 0 no active smoker, 1 active smoker
                        smoker,
                        # ever been diagnosed with hypertension according to self report: 0 no, 1 yes
                        hypertension.diag,
                        # municipality,
                        municipality,
                        # subdistrict,
                        subdistrict,
                        # personal identification
                        p.id,
                        # IFLS set
                        IFLS
  )
}

if (dataset.name=="nids_"){
  data <- dplyr::select(comb_2,
                        # location le: we combine province, municipality and subdistrict into one variable
                        # province,
                        province,
                        # cluster, most fine-grained information on location available,
                        cluster,
                        # rural vs. urban control, 1=urban, 2=rural,
                        ruralurban,
                        # interviewer ID
                        int.id,
                        # household ID,
                        hh.id,
                        # main measurement of sbp (average of second and 3rd measurement)
                        sbp=sbp.main,
                        # sex as 0=male, female=1
                        sex,
                        # age in years
                        age,
                        # highest level of education achieved: primary/secondary, tertiary
                        edu,
                        # body-mass-index (standard formula: (body weight in kg / (height in m)^2)
                        bmi,
                        # log of income variable
                        income.scaled=income.log,
                        # active smoking status: 0 no active smoker, 1 active smoker
                        smoker,
                        # ever been diagnosed with hypertension according to self report: 0 no, 1 yes
                        hypertension.diag
  )
}


if (dataset.name=="lasiw1_"){
  data <- dplyr::select(comb_2,
                        # location le: we combine province, municipality and subdistrict into one variable
                        province=hh1state,    # state
                        municipality=districtid,  # district
                        # rural vs. urban control, 1=urban, 2=rural # in LASI, 0=urban, 1=rural
                        ruralurban=hh1rural,
                        # interviewer ID
                        int.id=urid,
                        # household ID,
                        hh.id=hhid,
                        # main measurement of sbp  (average of second and 3rd measurement)
                        sbp=r1systo,
                        # sex as 0=male, female=1
                        sex=ragender,
                        # age in years
                        age=r1agey,
                        # highest level of education achieved: primary/secondary, tertiary
                        edu=raeduc3,
                        # body-mass-index (standard formula: (body weight in kg / (height in m)^2)
                        bmi=r1mbmi,
                        # log of income variable
                        income.scaled=loginc,
                        # active smoking status: 0 no active smoker, 1 active smoker
                        smoker, 
                        # ever been diagnosed with hypertension according to self report: 0 no, 1 yes
                        hypertension.diag=r1hibpe,
                        # subdistrict,
                        subdistrict=ssuid,                # SSU
  )
  
}

# remove object no longer needed to keep environment tidy
rm(comb_2)

## initial data editing
# remove incomplete observations
data <- na.omit(data)
# filter age outliers, restrict sample to individuals aged 45 and up
data <- dplyr::filter(data, age < 110)
if (dataset.name=="lasiw1_"){
  data <- dplyr::filter(data, age > 44)
}
# factorize level effect variables
data$hh.id <- as_factor(data$hh.id)
if (dataset.name=="lasiw1_"){
  data$edu <- as_factor(data$edu)
  data$province <- as_factor(data$province)
  data$ruralurban <- as_factor(data$ruralurban)
  data$sex <- as_factor(data$sex)
  data$smoker <- as_factor(data$smoker)
}

# sort data by interviewer ids
data <- dplyr::arrange(data, int.id)

summary(data$sbp)
summary(data)

## investigate proximity to normal distribution of sbp
# compare to random draws from normal distribution with equal mean and sd
tr.plot <- as.data.frame(cbind(data$sbp, rep("Observed SBP", length(data$sbp))))
or.n.d <- as.data.frame(cbind(rnorm(length(data$sbp),mean=mean(data$sbp),sd=sd(data$sbp)),
                              rep("Normal Benchmark", length(data$sbp))))
if (dataset.name=="lasiw1_"){
  tr.plot$V1 <- as.character(tr.plot$V1)
  tr.plot$V2 <- as.character(tr.plot$V2)
  or.n.d$V1 <- as.character(or.n.d$V1)
  or.n.d$V2 <- as.character(or.n.d$V2)
}
tr.plot1 <- rbind(tr.plot, or.n.d)
colnames(tr.plot1) <- c("Value","Label")

tp1 <- ggplot(data=tr.plot1, aes(x=as.numeric(Value), color=Label))+
  geom_density()+
  theme(legend.position = "top")+
  xlab("Systolic blood pressure")+ylab("Density")+
  theme_bw()

tp1

plot.name <- "sbp_distribution_vs_normal"
directory.and.file.name <- paste0(path.plots,dataset.name,plot.name,".pdf")
pdf(directory.and.file.name,width=6,height=4)
print(tp1)
dev.off()

# skewness
skewness(data$sbp)
# kurtosis
kurtosis(data$sbp)

# remove objects not needed in the following
rm(or.n.d,tr.plot,tr.plot1,tp1)

# grouping (needed later)
data <- dplyr::group_by(data, int.id)

## estimation
# baseline model without interviewer effects, but with location and hh random effects

if (dataset.name=="lasiw1_" | dataset.name=="iflsmerg_"){
  fit0 <- lmer(sbp ~ sex + age + bmi + income.scaled + smoker + edu + hypertension.diag + ruralurban +
                 (1 | province) +
                 (1 | municipality) +
                 (1 | subdistrict) +
                 (1 | hh.id)
               ,data = data,
               control = lmerControl(optimizer = "nloptwrap",
                                     check.conv.hess = "ignore",
                                     check.conv.grad = "ignore",
                                     check.conv.singular = "ignore"))
} else {
  fit0 <- lmer(sbp ~ sex + age + bmi + income.scaled + smoker + edu + hypertension.diag + ruralurban +
                 (1 | province) +
                 (1 | cluster) +
                 (1 | hh.id)
               ,data = data,
               control = lmerControl(optimizer = "nloptwrap",
                                     check.conv.hess = "ignore",
                                     check.conv.grad = "ignore",
                                     check.conv.singular = "ignore"))
}

summary(fit0)

# add interviewer effects to baseline model
fit1 <- update(fit0, . ~ . + (1 | int.id))
summary(fit1)

# check for heteroskedasticity
sbp <- seq(min(data$sbp), max(data$sbp), by = 1)
ord <- order(data$sbp)
err <- resid(fit1)[ord]

window = 5 # sbp.points

n <- length(sbp)
std <- rep(NA, n)
n.neighbours <- std
for (i in 1:n) {
  std[i] <- sd(err[abs(data$sbp - sbp[i]) < window])
  n.neighbours[i] <- sum(err[abs(data$sbp - sbp[i]) < window] != 0)
}
par(mfrow = c(3, 1))
plot(data$sbp[ord], err, xlab="Systolic blood pressure, in ascending order",
     ylab="Residuals from fitted model") # residuals vs response
plot(sbp, std, type = "l", lwd = 2, xlab="Systolic blood pressure, in ascending order",
     ylab="Rolling std") # error std-dev based on all obs in window around x-value 
plot(sbp, n.neighbours, type = "l", lwd = 2, col = 8,
     xlab="Systolic blood pressure, in ascending order",
     ylab="Nr. of neighbours") # number of obs used to calculate std-dev
par(mfrow = c(1, 1))

if (dataset.name=="nids_"){
  ## NIDS
  # check normality on the RE - verify that the order is correct
  r <- length(getME(fit1, "theta")) + 1
  idx <- getME(fit1, "Gp")
  khat <- getME(fit1, "b")[(idx[1] + 1):idx[2]]
  chat <- getME(fit1, "b")[(idx[2] + 1):idx[3]]
  vhat <- getME(fit1, "b")[(idx[3] + 1):idx[4]]
  phat <- getME(fit1, "b")[(idx[4] + 1):idx[5]]
  
  df <- rbind(data.frame(name = "Household Effect", value = khat),
              data.frame(name = "Cluster Effect", value = chat),
              data.frame(name = "Interviewer Effect", value = vhat),
              data.frame(name = "Province Effect", value = phat))
}

if (dataset.name=="iflsmerg_"){
  ## run if all level-effects are included
  # check normality on the RE - verify that the order is correct
  r <- length(getME(fit1, "theta")) + 1
  idx <- getME(fit1, "Gp")
  khat <- getME(fit1, "b")[(idx[1] + 1):idx[2]]
  shat <- getME(fit1, "b")[(idx[2] + 1):idx[3]]
  vhat <- getME(fit1, "b")[(idx[3] + 1):idx[4]]
  mhat <- getME(fit1, "b")[(idx[4] + 1):idx[5]]
  phat <- getME(fit1, "b")[(idx[5] + 1):idx[6]]
  
  df <- rbind(data.frame(name = "Household Effect", value = khat),
              data.frame(name = "Subdistrict Effect", value = shat),
              data.frame(name = "Interviewer Effect", value = vhat),
              data.frame(name = "Municipality Effect", value = mhat),
              data.frame(name = "Province Effect", value = phat))
}

if (dataset.name=="lasiw1_"){
  ## run if all level-effects are included
  # check normality on the RE - verify that the order is correct
  r <- length(getME(fit1, "theta")) + 1
  idx <- getME(fit1, "Gp")
  khat <- getME(fit1, "b")[(idx[1] + 1):idx[2]]
  shat <- getME(fit1, "b")[(idx[2] + 1):idx[3]]
  mhat <- getME(fit1, "b")[(idx[3] + 1):idx[4]]
  vhat <- getME(fit1, "b")[(idx[4] + 1):idx[5]]
  phat <- getME(fit1, "b")[(idx[5] + 1):idx[6]]
  
  df <- rbind(data.frame(name = "Household Effect", value = khat),
              data.frame(name = "SSU Effect", value = shat),
              data.frame(name = "District Effect", value = mhat),
              data.frame(name = "Interviewer Effect", value = vhat),
              data.frame(name = "State Effect", value = phat))
}

plt <- ggplot(df, aes(sample = value)) + theme_minimal() +
  geom_qq() + geom_qq_line(col = "red") +
  facet_wrap(~ name, scales = "free")

plt
rm(df)

plot.name <- "qq1"
directory.and.file.name <- paste0(path.plots,dataset.name,plot.name,".pdf")
pdf(directory.and.file.name,width=6,height=4)
print(plt)
dev.off()

## LRT to find out if interviewer effects matter
LRT_Bootstrap <- function(fit0, fit1, data, ...){
  
  # generate Bootstrap sample
  BootData <- data[sample(1:nrow(data), 1000), ]
  
  # fit models to bootstrap sample
  Bootfit0 <- update(fit0, data = BootData)
  Bootfit1 <- update(fit1, data = BootData)
  
  # return LRT statistic
  lrt = (2 * (logLik(Bootfit1) - logLik(Bootfit0)))[1]
}

lrt <- unlist(pbmclapply(1:100, LRT_Bootstrap, fit0 = fit0, fit1 = fit1,
                         data = data, mc.cores = detectCores() - 2))

# approximate LRT distribution by Greven et al.
lrt <- as.numeric(lrt)
lrt <- na.omit(lrt)

a <- mean(lrt)

p <- sum(lrt <= 0) / length(lrt)

plrt <- function(x, p, a) (1 - pchisq(x / a, 1)) * (1 - p)

LRT <- (2 * (logLik(fit1) - logLik(fit0)))[1] # gives back -inf, when sample is not truncated

plrt(LRT, p, a)

VarCorr(fit1)

## relative size of household effect
tibble::tibble(effect = as.data.frame(VarCorr(fit1))$grp, 
               variance = as.data.frame(VarCorr(fit1))$vcov, 
               variance_proportion_perc = 100*(variance / sum(variance)), 
               std = as.data.frame(VarCorr(fit1))$sdcor, 
               std_proportion = std / sum(std))

df <- tidyr::pivot_longer(data.frame("Null" = resid(fit0),
                                     "With interviewer effect" = resid(fit1)), 1:2)

# qqplots of fit0 and fit1, not saved right now
plt <- ggplot(df, aes(sample = value))+
  theme_minimal()+
  geom_qq()+
  geom_qq_line(col = "red")+
  facet_wrap(~ name, scales = "free")

plt
rm(df)

# Non-parametric bootstrap
source(paste0(path.codes,"npbt.R"))
if (dataset.name=="iflsmerg_"){
  Boot <- npbt(fit1, data=data, fixedgroup=data$province, clustergroup=data$municipality, R=1000)
}

if (dataset.name=="nids_"){
  Boot <- npbt(fit1, data=data, fixedgroup=data$province, clustergroup=data$cluster, R=1000)
}

if (dataset.name=="lasiw1_"){
  Boot <- npbt(fit1, data=data, fixedgroup=data$province, clustergroup=data$municipality, R=1000)
}

quantile(Boot$corrected$corrected, c(0.05, 0.95))
quantile(Boot$corrected$Uncorrected, c(0.05, 0.95))

plot.name <- "non_paramet_bootstrap"
directory.and.file.name <- paste0(path.plots,dataset.name,plot.name,".pdf")
pdf(directory.and.file.name,width=6,height=4)
print(Boot$plot)
dev.off()

## Correction
corr_obs <- function(object, data) {
  id <- c(F, names(lme4::getME(object, "cnms")) == "int.id") # int.id identifyer
  idx <- lme4::getME(object, "Gp")[c(which(id) - 1, which(id))] + c(1, 0) #range
  b <- lme4::getME(object, "b")[idx[1]:idx[2]] # interviewer RE
  ni <- dplyr::tally(data)$n
  ranef <- rep(b, ni)
  
  y <- data$sbp
  z <- y - ranef
  
  return(z)
}

eff_st <- paste0(path.codes,"effect_study.R")
source(eff_st,echo=TRUE,keep.source=TRUE)

